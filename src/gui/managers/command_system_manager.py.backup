#!/usr/bin/env python3
"""
Command System Manager for MainWindow

MainWindowì˜ Command System ê´€ë ¨ ë©”ì„œë“œë“¤ì„ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤ì…ë‹ˆë‹¤.
Command ì‹¤í–‰, Undo/Redo, UI Command ë¸Œë¦¬ì§€ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.
"""

import logging

from PyQt5.QtWidgets import QMainWindow

from app import ICommandInvoker, IUndoRedoManager, get_service
from src.app.journal import JournalManager
from src.app.staging import StagingManager
from src.app.ui import UICommandBridge
from src.app.undo_redo import QUndoStackBridge


class CommandSystemManager:
    """Command System ê´€ë ¨ ë©”ì„œë“œë“¤ì„ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤"""

    def __init__(self, main_window: QMainWindow):
        """CommandSystemManager ì´ˆê¸°í™”"""
        self.main_window = main_window
        self.logger = logging.getLogger(__name__)

        # Command System ë§¤ë‹ˆì €ë“¤
        self.command_invoker: ICommandInvoker | None = None
        self.undo_redo_manager: IUndoRedoManager | None = None

        # UI Command ì‹œìŠ¤í…œ
        self.staging_manager: StagingManager | None = None
        self.journal_manager: JournalManager | None = None
        self.undo_stack_bridge: QUndoStackBridge | None = None
        self.ui_command_bridge: UICommandBridge | None = None

        # ì´ˆê¸°í™”
        self.init_command_system()
        self.init_undo_redo_system()

    def init_command_system(self):
        """Command System ì´ˆê¸°í™”"""
        try:
            # Command Invoker ê°€ì ¸ì˜¤ê¸°
            self.command_invoker = get_service(ICommandInvoker)
            self.logger.info(f"âœ… CommandInvoker ì—°ê²°ë¨: {id(self.command_invoker)}")

        except Exception as e:
            self.logger.error(f"âš ï¸ Command System ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            self.command_invoker = None

    def init_undo_redo_system(self):
        """Undo/Redo System ì´ˆê¸°í™”"""
        try:
            # Undo/Redo Manager ê°€ì ¸ì˜¤ê¸°
            self.undo_redo_manager = get_service(IUndoRedoManager)
            self.logger.info(f"âœ… UndoRedoManager ì—°ê²°ë¨: {id(self.undo_redo_manager)}")

            # UI Command ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            self.init_ui_command_system()
            self.logger.info("âœ… UI Command ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ")

        except Exception as e:
            self.logger.error(f"âš ï¸ Undo/Redo System ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            self.undo_redo_manager = None

    def init_ui_command_system(self):
        """UI Command ì‹œìŠ¤í…œ ì´ˆê¸°í™”"""
        try:
            # ìŠ¤í…Œì´ì§• ë§¤ë‹ˆì € ì´ˆê¸°í™”
            self.staging_manager = StagingManager()
            self.logger.info(f"âœ… StagingManager ì´ˆê¸°í™”ë¨: {id(self.staging_manager)}")

            # ì €ë„ ë§¤ë‹ˆì € ì´ˆê¸°í™”
            self.journal_manager = JournalManager()
            self.logger.info(f"âœ… JournalManager ì´ˆê¸°í™”ë¨: {id(self.journal_manager)}")

            # QUndoStackBridge ì´ˆê¸°í™”
            self.undo_stack_bridge = QUndoStackBridge(
                staging_manager=self.staging_manager, journal_manager=self.journal_manager
            )
            self.logger.info(f"âœ… QUndoStackBridge ì´ˆê¸°í™”ë¨: {id(self.undo_stack_bridge)}")

            # UI Command ë¸Œë¦¬ì§€ ì´ˆê¸°í™”
            self.ui_command_bridge = UICommandBridge(
                main_window=self.main_window,
                undo_stack_bridge=self.undo_stack_bridge,
                staging_manager=self.staging_manager,
                journal_manager=self.journal_manager,
            )
            self.logger.info(f"âœ… UICommandBridge ì´ˆê¸°í™”ë¨: {id(self.ui_command_bridge)}")

            # UI Command ë¸Œë¦¬ì§€ ì‹œê·¸ë„ ì—°ê²°
            self.setup_ui_command_signals()
            self.logger.info("âœ… UI Command ì‹œê·¸ë„ ì—°ê²° ì™„ë£Œ")

        except Exception as e:
            self.logger.error(f"âš ï¸ UI Command ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            self.staging_manager = None
            self.journal_manager = None
            self.undo_stack_bridge = None
            self.ui_command_bridge = None

    def setup_ui_command_signals(self):
        """UI Command ì‹œê·¸ë„ ì—°ê²°"""
        try:
            if self.ui_command_bridge:
                # Command ì‹¤í–‰ ì™„ë£Œ ì‹œê·¸ë„
                self.ui_command_bridge.command_executed.connect(self.on_command_executed)
                self.ui_command_bridge.command_failed.connect(self.on_command_failed)
                self.ui_command_bridge.command_progress.connect(self.on_command_progress)

                # ìŠ¤í…Œì´ì§• ì‹œê·¸ë„
                self.ui_command_bridge.staging_progress.connect(self.on_staging_progress)
                self.ui_command_bridge.staging_completed.connect(self.on_staging_completed)

                # ì €ë„ ì‹œê·¸ë„
                self.ui_command_bridge.journal_updated.connect(self.on_journal_updated)

                self.logger.info("âœ… UI Command ì‹œê·¸ë„ ì—°ê²° ì™„ë£Œ")

        except Exception as e:
            self.logger.error(f"âš ï¸ UI Command ì‹œê·¸ë„ ì—°ê²° ì‹¤íŒ¨: {e}")

    # === ê¸°ì¡´ ì‹œìŠ¤í…œ í˜¸í™˜ì„± ë©”ì„œë“œë“¤ ===

    def undo_last_operation(self):
        """ë§ˆì§€ë§‰ ì‘ì—… ì‹¤í–‰ ì·¨ì†Œ (ê¸°ì¡´ ì‹œìŠ¤í…œ)"""
        try:
            if self.undo_redo_manager and self.undo_redo_manager.can_undo():
                success = self.undo_redo_manager.undo()
                if success:
                    self.logger.info("âœ… ì‹¤í–‰ ì·¨ì†Œ ì™„ë£Œ (ê¸°ì¡´ ì‹œìŠ¤í…œ)")
                else:
                    self.logger.error("âŒ ì‹¤í–‰ ì·¨ì†Œ ì‹¤íŒ¨ (ê¸°ì¡´ ì‹œìŠ¤í…œ)")
            else:
                self.logger.warning("âš ï¸ ì‹¤í–‰ ì·¨ì†Œí•  ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤ (ê¸°ì¡´ ì‹œìŠ¤í…œ)")
        except Exception as e:
            self.logger.error(f"âŒ ì‹¤í–‰ ì·¨ì†Œ ì‹¤íŒ¨ (ê¸°ì¡´ ì‹œìŠ¤í…œ): {e}")

    def redo_last_operation(self):
        """ë§ˆì§€ë§‰ ì‘ì—… ì¬ì‹¤í–‰ (ê¸°ì¡´ ì‹œìŠ¤í…œ)"""
        try:
            if self.undo_redo_manager and self.undo_redo_manager.can_redo():
                success = self.undo_redo_manager.redo()
                if success:
                    self.logger.info("âœ… ì¬ì‹¤í–‰ ì™„ë£Œ (ê¸°ì¡´ ì‹œìŠ¤í…œ)")
                else:
                    self.logger.error("âŒ ì¬ì‹¤í–‰ ì‹¤íŒ¨ (ê¸°ì¡´ ì‹œìŠ¤í…œ)")
            else:
                self.logger.warning("âš ï¸ ì¬ì‹¤í–‰í•  ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤ (ê¸°ì¡´ ì‹œìŠ¤í…œ)")
        except Exception as e:
            self.logger.error(f"âŒ ì¬ì‹¤í–‰ ì‹¤íŒ¨ (ê¸°ì¡´ ì‹œìŠ¤í…œ): {e}")

    # === ìƒˆë¡œìš´ UI Command ì‹œìŠ¤í…œ ë©”ì„œë“œë“¤ ===

    def undo_last_operation_new(self):
        """ë§ˆì§€ë§‰ ì‘ì—… ì‹¤í–‰ ì·¨ì†Œ (ìƒˆë¡œìš´ UI Command ì‹œìŠ¤í…œ)"""
        return self.undo_last_operation_ui()

    def redo_last_operation_new(self):
        """ë§ˆì§€ë§‰ ì‘ì—… ì¬ì‹¤í–‰ (ìƒˆë¡œìš´ UI Command ì‹œìŠ¤í…œ)"""
        return self.redo_last_operation_ui()

    # === ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë©”ì„œë“œë“¤ ===

    def on_command_executed(self, command_id: str, result):
        """Command ì‹¤í–‰ ì™„ë£Œ ì²˜ë¦¬"""
        try:
            self.logger.info(f"âœ… UI Command ì‹¤í–‰ ì™„ë£Œ: {command_id}")

            # ìƒíƒœë°” ì—…ë°ì´íŠ¸
            if hasattr(self.main_window, "statusBar"):
                self.main_window.statusBar().showMessage(
                    f"Command ì‹¤í–‰ ì™„ë£Œ: {result.description if hasattr(result, 'description') else command_id}"
                )

            # ê²°ê³¼ì— ë”°ë¥¸ ì¶”ê°€ ì²˜ë¦¬
            if hasattr(result, "staged_files") and result.staged_files:
                self.logger.info(f"ğŸ“ {len(result.staged_files)}ê°œ íŒŒì¼ì´ ìŠ¤í…Œì´ì§•ë˜ì—ˆìŠµë‹ˆë‹¤")

        except Exception as e:
            self.logger.error(f"âŒ Command ì‹¤í–‰ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    def on_command_failed(self, command_id: str, error_message: str):
        """Command ì‹¤í–‰ ì‹¤íŒ¨ ì²˜ë¦¬"""
        try:
            self.logger.error(f"âŒ UI Command ì‹¤í–‰ ì‹¤íŒ¨: {command_id} - {error_message}")

            # ìƒíƒœë°” ì—…ë°ì´íŠ¸
            if hasattr(self.main_window, "statusBar"):
                self.main_window.statusBar().showMessage(f"Command ì‹¤í–‰ ì‹¤íŒ¨: {error_message}")

        except Exception as e:
            self.logger.error(f"âŒ Command ì‹¤í–‰ ì‹¤íŒ¨ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    def on_command_progress(self, current: int, total: int, description: str):
        """Command ì§„í–‰ ìƒí™© ì²˜ë¦¬"""
        try:
            self.logger.info(f"ğŸ“Š Command ì§„í–‰ ìƒí™©: {current}/{total} - {description}")

            # ìƒíƒœë°” ì—…ë°ì´íŠ¸
            if hasattr(self.main_window, "statusBar"):
                self.main_window.statusBar().showMessage(
                    f"ì§„í–‰ ì¤‘: {description} ({current}/{total})"
                )

        except Exception as e:
            self.logger.error(f"âŒ Command ì§„í–‰ ìƒí™© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    def on_staging_progress(self, current: int, total: int, description: str):
        """ìŠ¤í…Œì´ì§• ì§„í–‰ ìƒí™© ì²˜ë¦¬"""
        try:
            self.logger.info(f"ğŸ“ ìŠ¤í…Œì´ì§• ì§„í–‰ ìƒí™©: {current}/{total} - {description}")

            # ìƒíƒœë°” ì—…ë°ì´íŠ¸
            if hasattr(self.main_window, "statusBar"):
                self.main_window.statusBar().showMessage(
                    f"ìŠ¤í…Œì´ì§• ì¤‘: {description} ({current}/{total})"
                )

        except Exception as e:
            self.logger.error(f"âŒ ìŠ¤í…Œì´ì§• ì§„í–‰ ìƒí™© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    def on_staging_completed(self, staged_files: list):
        """ìŠ¤í…Œì´ì§• ì™„ë£Œ ì²˜ë¦¬"""
        try:
            self.logger.info(f"âœ… ìŠ¤í…Œì´ì§• ì™„ë£Œ: {len(staged_files)}ê°œ íŒŒì¼")

            # ìƒíƒœë°” ì—…ë°ì´íŠ¸
            if hasattr(self.main_window, "statusBar"):
                self.main_window.statusBar().showMessage(
                    f"ìŠ¤í…Œì´ì§• ì™„ë£Œ: {len(staged_files)}ê°œ íŒŒì¼ ì¤€ë¹„ë¨"
                )

        except Exception as e:
            self.logger.error(f"âŒ ìŠ¤í…Œì´ì§• ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    def on_journal_updated(self, command_id: str, journal_entry_id: str):
        """ì €ë„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬"""
        try:
            self.logger.info(f"ğŸ“ ì €ë„ ì—…ë°ì´íŠ¸: {command_id} -> {journal_entry_id}")

            # ìƒíƒœë°” ì—…ë°ì´íŠ¸
            if hasattr(self.main_window, "statusBar"):
                self.main_window.statusBar().showMessage(f"ì €ë„ ì—…ë°ì´íŠ¸: {journal_entry_id}")

        except Exception as e:
            self.logger.error(f"âŒ ì €ë„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    # === ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë©”ì„œë“œë“¤ ===

    def handle_command_executed(self, event):
        """Command ì‹¤í–‰ ì™„ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬"""
        try:
            self.logger.info(f"â–¶ï¸ [CommandSystemManager] ëª…ë ¹ ì‹¤í–‰: {event.command_id}")
            self.main_window.update_status_bar("ëª…ë ¹ ì‹¤í–‰ë¨")
        except Exception as e:
            self.logger.error(f"âŒ Command ì‹¤í–‰ ì™„ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    def handle_command_undone(self, event):
        """Command ì‹¤í–‰ ì·¨ì†Œ ì´ë²¤íŠ¸ ì²˜ë¦¬"""
        try:
            self.logger.info(f"â†©ï¸ [CommandSystemManager] ëª…ë ¹ ì‹¤í–‰ ì·¨ì†Œ: {event.command_id}")
            self.main_window.update_status_bar("ëª…ë ¹ ì‹¤í–‰ ì·¨ì†Œë¨")
        except Exception as e:
            self.logger.error(f"âŒ Command ì‹¤í–‰ ì·¨ì†Œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    def handle_command_redone(self, event):
        """Command ì¬ì‹¤í–‰ ì´ë²¤íŠ¸ ì²˜ë¦¬"""
        try:
            self.logger.info(f"â†ªï¸ [CommandSystemManager] ëª…ë ¹ ì¬ì‹¤í–‰: {event.command_id}")
            self.main_window.update_status_bar("ëª…ë ¹ ì¬ì‹¤í–‰ë¨")
        except Exception as e:
            self.logger.error(f"âŒ Command ì¬ì‹¤í–‰ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    def handle_command_failed(self, event):
        """Command ì‹¤íŒ¨ ì´ë²¤íŠ¸ ì²˜ë¦¬"""
        try:
            self.logger.error(
                f"âŒ [CommandSystemManager] ëª…ë ¹ ì‹¤íŒ¨: {event.command_id} - {event.error_message}"
            )
            self.main_window.show_error_message("ëª…ë ¹ ì‹¤íŒ¨", event.error_message)
        except Exception as e:
            self.logger.error(f"âŒ Command ì‹¤íŒ¨ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    # === UI Command ê³µê°œ API ===

    def execute_command(self, command, show_progress: bool = True) -> bool:
        """UI Command ë¸Œë¦¬ì§€ë¥¼ í†µí•´ Command ì‹¤í–‰"""
        if not self.ui_command_bridge:
            self.logger.error("âŒ UI Command ë¸Œë¦¬ì§€ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
            return False

        return self.ui_command_bridge.execute_command(command, show_progress)

    def execute_batch_commands(self, commands: list, description: str = "") -> bool:
        """UI Command ë¸Œë¦¬ì§€ë¥¼ í†µí•´ ë°°ì¹˜ Command ì‹¤í–‰"""
        if not self.ui_command_bridge:
            self.logger.error("âŒ UI Command ë¸Œë¦¬ì§€ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
            return False

        return self.ui_command_bridge.execute_batch_commands(commands, description)

    def undo_last_operation_ui(self) -> bool:
        """UI Command ë¸Œë¦¬ì§€ë¥¼ í†µí•´ ë§ˆì§€ë§‰ ì‘ì—… ì·¨ì†Œ"""
        if not self.ui_command_bridge:
            self.logger.error("âŒ UI Command ë¸Œë¦¬ì§€ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
            return False

        return self.ui_command_bridge.undo_last_operation()

    def redo_last_operation_ui(self) -> bool:
        """UI Command ë¸Œë¦¬ì§€ë¥¼ í†µí•´ ë§ˆì§€ë§‰ ì‘ì—… ì¬ì‹¤í–‰"""
        if not self.ui_command_bridge:
            self.logger.error("âŒ UI Command ë¸Œë¦¬ì§€ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
            return False

        return self.ui_command_bridge.redo_last_operation()

    def show_command_history_ui(self):
        """UI Command ë¸Œë¦¬ì§€ë¥¼ í†µí•´ Command íˆìŠ¤í† ë¦¬ í‘œì‹œ"""
        if not self.ui_command_bridge:
            self.logger.error("âŒ UI Command ë¸Œë¦¬ì§€ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
            return

        self.ui_command_bridge.show_command_history()

    def show_staging_summary_ui(self):
        """UI Command ë¸Œë¦¬ì§€ë¥¼ í†µí•´ ìŠ¤í…Œì´ì§• ìš”ì•½ í‘œì‹œ"""
        if not self.ui_command_bridge:
            self.logger.error("âŒ UI Command ë¸Œë¦¬ì§€ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
            return

        self.ui_command_bridge.show_staging_summary()
